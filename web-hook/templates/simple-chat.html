<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - Multi-Model</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 700px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .config-toggle {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
        }

        .config-panel {
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .config-panel.show {
            display: block;
        }

        .config-row {
            margin-bottom: 15px;
        }

        .config-row label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .config-row input,
        .config-row select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .config-row select {
            cursor: pointer;
        }

        .provider-preset {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 6px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chat-area {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-bubble {
            background: white;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-area input:focus {
            border-color: #667eea;
        }

        .input-area button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .input-area button:hover {
            transform: scale(1.05);
        }

        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.active {
            display: block;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        .status-configured {
            background: #4caf50;
            color: white;
        }

        .status-unconfigured {
            background: #ff9800;
            color: white;
        }

        /* æ€è€ƒè¿‡ç¨‹æ ·å¼ */
        .thinking-block {
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .thinking-header {
            background: #f5f5f5;
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            transition: background 0.2s;
        }

        .thinking-header:hover {
            background: #eeeeee;
        }

        .thinking-header .toggle-icon {
            font-size: 12px;
            transition: transform 0.3s;
        }

        .thinking-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .thinking-header .label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .thinking-content {
            background: #fafafa;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: #666;
            border-top: 1px solid #e0e0e0;
            max-height: 400px;
            overflow-y: auto;
        }

        .thinking-content.collapsed {
            display: none;
        }

        .thinking-status {
            font-size: 12px;
            color: #667eea;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Chat <span id="statusBadge" class="status-badge status-unconfigured">æœªé…ç½®</span></h1>
            <button class="config-toggle" onclick="toggleConfig()">âš™ï¸</button>
        </div>

        <div class="config-panel" id="configPanel">
            <div class="provider-preset">
                <button class="preset-btn" onclick="applyPreset('anthropic')">Anthropic</button>
                <button class="preset-btn" onclick="applyPreset('openai')">OpenAI</button>
                <button class="preset-btn" onclick="applyPreset('zhipuai')">æ™ºè°±AI</button>
                <button class="preset-btn" onclick="applyPreset('ollama')">Ollama</button>
                <button class="preset-btn" onclick="applyPreset('deepseek')">DeepSeek</button>
                <button class="preset-btn" onclick="applyPreset('custom')">è‡ªå®šä¹‰</button>
            </div>

            <div class="config-row">
                <label>API åœ°å€ (Base URL)</label>
                <input type="text" id="baseUrl" placeholder="https://api.anthropic.com" />
            </div>

            <div class="config-row">
                <label>API å¯†é’¥ (Auth Token)</label>
                <input type="password" id="authToken" placeholder="sk-ant-api03-..." />
            </div>

            <div class="config-row">
                <label>æ¨¡å‹ (Model)</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="modelName" placeholder="claude-3-5-sonnet-20241022" style="flex: 1;" />
                    <button class="preset-btn" onclick="fetchModels()" title="è·å–æ¨¡å‹åˆ—è¡¨" id="fetchModelsBtn">ğŸ“‹</button>
                </div>
                <select id="modelSelect" style="display: none; margin-top: 5px;" onchange="document.getElementById('modelName').value = this.value;">
                    <option value="">-- é€‰æ‹©æ¨¡å‹ --</option>
                </select>
            </div>

            <div class="config-row">
                <label>API æ ¼å¼</label>
                <select id="apiFormat" onchange="onApiFormatChange()">
                    <option value="anthropic">Anthropic (Messages API)</option>
                    <option value="openai">OpenAI (Chat Completions)</option>
                </select>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="preset-btn" style="width: 100%; padding: 10px;" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
                <button class="preset-btn" style="width: 100%; padding: 10px;" onclick="fetchModels()">è·å–æ¨¡å‹åˆ—è¡¨</button>
            </div>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="message assistant">
                <div class="message-bubble">
                    ä½ å¥½ï¼æˆ‘æ˜¯ AI åŠ©æ‰‹ã€‚è¯·å…ˆç‚¹å‡»å³ä¸Šè§’ âš™ï¸ é…ç½® APIï¼Œç„¶åå¼€å§‹å¯¹è¯ã€‚
                </div>
            </div>
        </div>

        <div class="loading" id="loading">AI æ­£åœ¨æ€è€ƒ</div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." />
            <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        // é…ç½®
        let config = {
            baseUrl: '',
            authToken: '',
            model: 'claude-3-5-sonnet-20241022',
            apiFormat: 'anthropic'
        };

        const chatArea = document.getElementById('chatArea');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const loading = document.getElementById('loading');
        const statusBadge = document.getElementById('statusBadge');

        // åŠ è½½é…ç½®
        function loadConfig() {
            const saved = localStorage.getItem('ai-chat-config');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('baseUrl').value = config.baseUrl || '';
                document.getElementById('authToken').value = config.authToken || '';
                document.getElementById('modelName').value = config.model || '';
                document.getElementById('apiFormat').value = config.apiFormat || 'anthropic';
                updateStatus();
            }
        }

        // éªŒè¯é…ç½®
        async function validateConfig(baseUrl, authToken, model, apiFormat) {
            if (!baseUrl || !authToken || !model) {
                return { valid: false, message: 'è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯ï¼ˆAPI åœ°å€ã€å¯†é’¥ã€æ¨¡å‹ï¼‰' };
            }

            let url, headers, body;

            if (apiFormat === 'anthropic') {
                url = `${baseUrl.replace(/\/$/, '')}/v1/messages`;
                headers = {
                    'x-api-key': authToken,
                    'anthropic-version': '2023-06-01',
                    'content-type': 'application/json',
                    'dangerously-allow-browser': 'true'
                };
                body = {
                    model: model,
                    max_tokens: 100,
                    messages: [{ role: 'user', content: 'Hi' }]
                };
            } else {
                // OpenAI æ ¼å¼
                url = `${baseUrl.replace(/\/$/, '')}/chat/completions`;
                headers = {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                };
                body = {
                    model: model,
                    messages: [{ role: 'user', content: 'Hi' }],
                    max_tokens: 100
                };
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.error?.message || errorData.message || `HTTP ${response.status}`;

                    // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´å‹å¥½çš„æç¤º
                    if (response.status === 401 || response.status === 403) {
                        return { valid: false, message: `API å¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ (${errorMsg})` };
                    } else if (response.status === 404) {
                        return { valid: false, message: `æ¨¡å‹ "${model}" ä¸å­˜åœ¨æˆ–ç«¯ç‚¹é”™è¯¯ (${errorMsg})` };
                    } else if (response.status === 429) {
                        return { valid: false, message: `è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯• (${errorMsg})` };
                    } else if (errorMsg.includes('ä½™é¢') || errorMsg.includes('èµ„æºåŒ…')) {
                        return { valid: false, message: `è´¦æˆ·ä½™é¢ä¸è¶³æˆ–èµ„æºåŒ…å·²ç”¨å®Œ (${errorMsg})` };
                    } else {
                        return { valid: false, message: `é…ç½®éªŒè¯å¤±è´¥: ${errorMsg}` };
                    }
                }

                return { valid: true, message: 'é…ç½®éªŒè¯æˆåŠŸï¼' };
            } catch (error) {
                return { valid: false, message: `ç½‘ç»œé”™è¯¯: ${error.message}` };
            }
        }

        // ä¿å­˜é…ç½®ï¼ˆå¸¦éªŒè¯ï¼‰
        async function saveConfig() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const authToken = document.getElementById('authToken').value.trim();
            const model = document.getElementById('modelName').value.trim();
            const apiFormat = document.getElementById('apiFormat').value;

            if (!baseUrl || !authToken || !model) {
                alert('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯');
                return;
            }

            // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œæ˜¾ç¤ºéªŒè¯ä¸­çŠ¶æ€
            const saveBtn = event.target;
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'éªŒè¯ä¸­...';

            addMessage('assistant', 'æ­£åœ¨éªŒè¯é…ç½®ï¼Œè¯·ç¨å€™...');

            // éªŒè¯é…ç½®
            const result = await validateConfig(baseUrl, authToken, model, apiFormat);

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;

            if (result.valid) {
                // éªŒè¯æˆåŠŸï¼Œä¿å­˜é…ç½®
                config.baseUrl = baseUrl;
                config.authToken = authToken;
                config.model = model;
                config.apiFormat = apiFormat;

                localStorage.setItem('ai-chat-config', JSON.stringify(config));
                updateStatus();
                toggleConfig();

                addMessage('assistant', 'âœ… é…ç½®éªŒè¯æˆåŠŸå¹¶å·²ä¿å­˜ï¼ç°åœ¨å¯ä»¥å¼€å§‹å¯¹è¯äº†ã€‚');
            } else {
                // éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                addMessage('assistant', `âŒ ${result.message}\n\nè¯·æ£€æŸ¥é…ç½®åé‡è¯•ã€‚`);
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus() {
            if (config.baseUrl && config.authToken) {
                statusBadge.textContent = 'å·²é…ç½®';
                statusBadge.className = 'status-badge status-configured';
            } else {
                statusBadge.textContent = 'æœªé…ç½®';
                statusBadge.className = 'status-badge status-unconfigured';
            }
        }

        // åº”ç”¨é¢„è®¾
        function applyPreset(preset) {
            const presets = {
                anthropic: {
                    baseUrl: 'https://api.anthropic.com',
                    model: 'claude-3-5-sonnet-20241022',
                    apiFormat: 'anthropic'
                },
                openai: {
                    baseUrl: 'https://api.openai.com/v1',
                    model: 'gpt-4o-mini',
                    apiFormat: 'openai'
                },
                zhipuai: {
                    baseUrl: 'https://open.bigmodel.cn/api/anthropic',
                    model: 'glm-4-plus',
                    apiFormat: 'anthropic'
                },
                ollama: {
                    baseUrl: 'http://localhost:11434/v1',
                    model: 'llama3',
                    apiFormat: 'openai'
                },
                deepseek: {
                    baseUrl: 'https://api.deepseek.com/v1',
                    model: 'deepseek-chat',
                    apiFormat: 'openai'
                },
                custom: {
                    baseUrl: '',
                    model: '',
                    apiFormat: 'anthropic'
                }
            };

            const p = presets[preset];
            document.getElementById('baseUrl').value = p.baseUrl;
            document.getElementById('modelName').value = p.model;
            document.getElementById('apiFormat').value = p.apiFormat;
        }

        // åˆ‡æ¢é…ç½®é¢æ¿
        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            panel.classList.toggle('show');
        }

        // API æ ¼å¼å˜åŒ–æ—¶æ›´æ–°æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹æç¤º
        function onApiFormatChange() {
            // å¯ä»¥æ ¹æ®ä¸åŒæ ¼å¼æ˜¾ç¤ºä¸åŒçš„æç¤º
        }

        // è·å–æ¨¡å‹åˆ—è¡¨
        async function fetchModels() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const authToken = document.getElementById('authToken').value.trim();
            const apiFormat = document.getElementById('apiFormat').value;
            const fetchBtn = document.getElementById('fetchModelsBtn');
            const modelSelect = document.getElementById('modelSelect');

            if (!baseUrl || !authToken) {
                alert('è¯·å…ˆé…ç½® API åœ°å€å’Œå¯†é’¥');
                return;
            }

            fetchBtn.disabled = true;
            fetchBtn.textContent = 'â³';

            try {
                let url, headers, models = [];

                if (apiFormat === 'openai') {
                    // OpenAI æ ¼å¼ - ä½¿ç”¨ /models ç«¯ç‚¹
                    url = baseUrl.replace(/\/$/, '') + '/models';
                    headers = {
                        'Authorization': `Bearer ${authToken}`
                    };
                } else {
                    // Anthropic æ ¼å¼ - ä½¿ç”¨ /models ç«¯ç‚¹ï¼ˆå¦‚æœæ”¯æŒï¼‰æˆ–æä¾›é¢„è®¾åˆ—è¡¨
                    url = baseUrl.replace(/\/$/, '') + '/models';
                    headers = {
                        'x-api-key': authToken,
                        'anthropic-version': '2023-06-01'
                    };
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                // è§£æä¸åŒæ ¼å¼çš„å“åº”
                if (data.data && Array.isArray(data.data)) {
                    // OpenAI æ ¼å¼
                    models = data.data.map(m => m.id);
                } else if (data.models && Array.isArray(data.models)) {
                    // å…¶ä»–æ ¼å¼
                    models = data.models.map(m => m.id || m.name);
                } else if (Array.isArray(data)) {
                    models = data.map(m => m.id || m.name);
                }

                if (models.length === 0) {
                    // å¦‚æœ API ä¸æ”¯æŒ /models ç«¯ç‚¹ï¼Œæä¾›é¢„è®¾åˆ—è¡¨
                    models = getFallbackModels(apiFormat, baseUrl);
                }

                // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨
                modelSelect.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡å‹ --</option>' +
                    models.map(m => `<option value="${m}">${m}</option>`).join('');
                modelSelect.style.display = 'block';

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const firstModel = models[0];
                if (firstModel) {
                    document.getElementById('modelName').value = firstModel;
                    addMessage('assistant', `æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹ã€‚å·²é€‰æ‹©: ${firstModel}`);
                }

            } catch (error) {
                console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);

                // æä¾›é¢„è®¾æ¨¡å‹åˆ—è¡¨
                const fallbackModels = getFallbackModels(apiFormat, baseUrl);
                modelSelect.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡å‹ --</option>' +
                    fallbackModels.map(m => `<option value="${m}">${m}</option>`).join('');
                modelSelect.style.display = 'block';

                addMessage('assistant', `API ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨ã€‚å·²åŠ è½½ ${fallbackModels.length} ä¸ªé¢„è®¾æ¨¡å‹ã€‚\n\næç¤º: ${error.message}`);
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'ğŸ“‹';
            }
        }

        // è·å–é¢„è®¾æ¨¡å‹åˆ—è¡¨ï¼ˆå½“ API ä¸æ”¯æŒ /models æ—¶ï¼‰
        function getFallbackModels(apiFormat, baseUrl) {
            const url = baseUrl.toLowerCase();

            // æ™ºè°± AI
            if (url.includes('bigmodel.cn') || url.includes('zhipuai')) {
                return ['glm-4-plus', 'glm-4-flash', 'glm-4-air', 'glm-4-flashx', 'glm-4-0520', 'glm-3-turbo'];
            }

            // OpenAI
            if (url.includes('api.openai.com')) {
                return ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-3.5-turbo', 'o1-preview', 'o1-mini'];
            }

            // Anthropic
            if (url.includes('api.anthropic.com')) {
                return ['claude-3-5-sonnet-20241022', 'claude-3-5-haiku-20241022', 'claude-3-opus-20240229', 'claude-3-sonnet-20240229'];
            }

            // DeepSeek
            if (url.includes('deepseek')) {
                return ['deepseek-chat', 'deepseek-coder'];
            }

            // Ollama (æœ¬åœ°)
            if (url.includes('localhost') || url.includes('11434')) {
                return ['llama3', 'llama3:8b', 'mistral', 'qwen2', 'codellama', 'phi3'];
            }

            // é»˜è®¤åˆ—è¡¨
            if (apiFormat === 'anthropic') {
                return ['claude-3-5-sonnet-20241022', 'claude-3-5-haiku-20241022'];
            } else {
                return ['gpt-4o-mini', 'llama3'];
            }
        }

        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `<div class="message-bubble">${escapeHtml(content)}</div>`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatContent(text) {
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        // åˆ›å»ºæ€è€ƒè¿‡ç¨‹åŒºå—
        function createThinkingBlock(content) {
            const block = document.createElement('div');
            block.className = 'thinking-block';

            const header = document.createElement('div');
            header.className = 'thinking-header collapsed';
            header.innerHTML = `
                <span class="toggle-icon">â–¼</span>
                <span class="label">ğŸ’­ æ€è€ƒè¿‡ç¨‹</span>
                <span class="thinking-status">å·²æŠ˜å </span>
            `;
            header.onclick = () => toggleThinking(header);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'thinking-content collapsed';
            contentDiv.innerHTML = formatContent(content);

            block.appendChild(header);
            block.appendChild(contentDiv);

            return block;
        }

        // åˆ‡æ¢æ€è€ƒè¿‡ç¨‹æŠ˜å çŠ¶æ€
        function toggleThinking(header) {
            const content = header.nextElementSibling;
            const status = header.querySelector('.thinking-status');

            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');

            if (header.classList.contains('collapsed')) {
                status.textContent = 'å·²æŠ˜å ';
            } else {
                status.textContent = 'å±•å¼€æŸ¥çœ‹';
            }
        }

        // æ·»åŠ å¸¦æ€è€ƒè¿‡ç¨‹çš„æ¶ˆæ¯
        function addMessageWithThinking(role, content, thinking) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            // å¦‚æœæœ‰æ€è€ƒå†…å®¹ï¼Œå…ˆæ·»åŠ æ€è€ƒåŒºå—
            if (thinking) {
                const thinkingBlock = createThinkingBlock(thinking);
                bubble.appendChild(thinkingBlock);
            }

            // æ·»åŠ æ­£æ–‡å†…å®¹
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = formatContent(content);
            bubble.appendChild(contentDiv);

            messageDiv.appendChild(bubble);
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function sendMessage() {
            const prompt = userInput.value.trim();

            if (!prompt) return;

            if (!config.baseUrl || !config.authToken) {
                alert('è¯·å…ˆé…ç½® API åœ°å€å’Œå¯†é’¥');
                toggleConfig();
                return;
            }

            addMessage('user', prompt);
            userInput.value = '';

            userInput.disabled = true;
            sendBtn.disabled = true;
            loading.classList.add('active');

            try {
                let url, headers, body;

                if (config.apiFormat === 'anthropic') {
                    url = `${config.baseUrl}/v1/messages`;
                    headers = {
                        'x-api-key': config.authToken,
                        'anthropic-version': '2023-06-01',
                        'content-type': 'application/json',
                        'dangerously-allow-browser': 'true'
                    };
                    body = {
                        model: config.model,
                        max_tokens: 4096,
                        messages: [{ role: 'user', content: prompt }]
                    };
                    // å¯ç”¨æ‰©å±•æ€è€ƒï¼ˆå¦‚æœæ¨¡å‹æ”¯æŒï¼‰
                    if (config.model.includes('claude')) {
                        body.extended_thinking = {
                            max_tokens: 8000
                        };
                    }
                } else {
                    // OpenAI æ ¼å¼
                    url = `${config.baseUrl}/chat/completions`;
                    headers = {
                        'Authorization': `Bearer ${config.authToken}`,
                        'Content-Type': 'application/json'
                    };
                    body = {
                        model: config.model,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 4096
                    };
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: { message: 'è¯·æ±‚å¤±è´¥' } }));
                    throw new Error(error.error?.message || error.message || 'è¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();
                let assistantMessage = '';
                let thinkingMessage = '';

                if (config.apiFormat === 'anthropic') {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ€è€ƒå†…å®¹
                    if (data.content && Array.isArray(data.content)) {
                        for (const block of data.content) {
                            if (block.type === 'thinking') {
                                thinkingMessage = block.thinking || '';
                            } else if (block.type === 'text') {
                                assistantMessage = block.text || '';
                            }
                        }
                        // å¦‚æœæ²¡æœ‰æ€è€ƒå†…å®¹ï¼Œä½¿ç”¨æ—§çš„æ ¼å¼
                        if (!assistantMessage && !thinkingMessage) {
                            assistantMessage = data.content[0]?.text || '';
                        }
                    }
                } else {
                    assistantMessage = data.choices[0].message.content;
                }

                // æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆåŒ…å«æ€è€ƒè¿‡ç¨‹ï¼‰
                addMessageWithThinking('assistant', assistantMessage, thinkingMessage);

            } catch (error) {
                addMessage('assistant', `é”™è¯¯: ${error.message}`);
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                loading.classList.remove('active');
                userInput.focus();
            }
        }

        // Enter é”®å‘é€
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // åˆå§‹åŒ–
        loadConfig();
    </script>
</body>
</html>
