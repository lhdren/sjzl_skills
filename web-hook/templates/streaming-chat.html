<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - Streaming Multi-Model</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #16213e;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #0f3460;
            position: relative;
        }

        .header h1 {
            color: #e94560;
            font-size: 24px;
        }

        .config-toggle {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid #e94560;
            color: #e94560;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
        }

        .config-toggle:hover {
            background: rgba(233, 69, 96, 0.3);
        }

        .config-panel {
            display: none;
            padding: 20px;
            background: #0f3460;
            border-bottom: 1px solid #16213e;
        }

        .config-panel.show {
            display: block;
        }

        .config-row {
            margin-bottom: 15px;
        }

        .config-row label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .config-row input,
        .config-row select {
            width: 100%;
            padding: 10px;
            background: #1a1a2e;
            border: 1px solid #2a2a4e;
            border-radius: 6px;
            font-size: 14px;
            color: #eee;
        }

        .config-row input:focus,
        .config-row select:focus {
            outline: none;
            border-color: #e94560;
        }

        .provider-preset {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 6px 12px;
            background: #1a1a2e;
            border: 1px solid #2a2a4e;
            color: #eee;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: #e94560;
            border-color: #e94560;
        }

        .chat-container {
            flex: 1;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.user .avatar {
            background: #e94560;
            color: white;
        }

        .message.assistant .avatar {
            background: #0f3460;
            color: #e94560;
        }

        .message-content {
            background: #16213e;
            padding: 16px 20px;
            border-radius: 12px;
            max-width: 70%;
            line-height: 1.6;
            color: #eee;
        }

        .message.user .message-content {
            background: #e94560;
            color: white;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .input-container {
            background: #16213e;
            padding: 20px;
            border-top: 1px solid #0f3460;
        }

        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
        }

        .input-wrapper textarea {
            flex: 1;
            background: #0f3460;
            border: 2px solid #1a1a2e;
            border-radius: 12px;
            padding: 14px 18px;
            color: #eee;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-wrapper textarea:focus {
            border-color: #e94560;
        }

        .input-wrapper button {
            padding: 14px 28px;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .input-wrapper button:hover:not(:disabled) {
            background: #ff6b6b;
            transform: translateY(-2px);
        }

        .input-wrapper button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .action-btn {
            padding: 8px 16px;
            background: #0f3460;
            color: #eee;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .action-btn:hover {
            background: #1a1a2e;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        .status-configured {
            background: #4caf50;
            color: white;
        }

        .status-unconfigured {
            background: #ff9800;
            color: white;
        }

        pre {
            background: #0f3460;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }

        /* æ€è€ƒè¿‡ç¨‹æ ·å¼ */
        .thinking-block {
            margin-bottom: 12px;
            border: 1px solid #3a3a5e;
            border-radius: 8px;
            overflow: hidden;
        }

        .thinking-header {
            background: #2a2a4e;
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            transition: background 0.2s;
        }

        .thinking-header:hover {
            background: #3a3a5e;
        }

        .thinking-header .toggle-icon {
            font-size: 12px;
            transition: transform 0.3s;
        }

        .thinking-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .thinking-header .label {
            font-size: 13px;
            color: #aaa;
            font-weight: 500;
        }

        .thinking-content {
            background: #1a1a2e;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: #999;
            border-top: 1px solid #3a3a5e;
            max-height: 400px;
            overflow-y: auto;
        }

        .thinking-content.collapsed {
            display: none;
        }

        .thinking-status {
            font-size: 12px;
            color: #e94560;
            font-style: italic;
        }
        }

        code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }

        /* ä»£ç å—å¢å¼ºæ ·å¼ */
        .code-block {
            background: #0f3460;
            border-radius: 8px;
            margin: 12px 0;
            overflow: hidden;
            border: 1px solid #2a2a4e;
        }

        .code-header {
            background: #1a1a2e;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a2a4e;
            user-select: none;
        }

        .code-lang {
            font-size: 12px;
            color: #e94560;
            font-weight: 500;
            text-transform: uppercase;
        }

        .code-actions {
            display: flex;
            gap: 8px;
        }

        .code-btn {
            background: transparent;
            border: 1px solid #3a3a5e;
            color: #aaa;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .code-btn:hover {
            background: #2a2a4e;
            color: #e94560;
            border-color: #e94560;
        }

        .code-btn.copied {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .code-content {
            position: relative;
            max-height: 500px;
            overflow: auto;
            transition: max-height 0.3s ease;
        }

        .code-content.collapsed {
            max-height: 0;
        }

        .code-content pre {
            margin: 0;
            padding: 16px;
            background: transparent;
            border-radius: 0;
            border: none;
        }

        .code-content code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #e0e0e0;
            white-space: pre;
        }

        /* è¡Œå†…ä»£ç  */
        .inline-code {
            background: #2a2a4e;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #e94560;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AI Streaming Chat <span id="statusBadge" class="status-badge status-unconfigured">æœªé…ç½®</span></h1>
        <button class="config-toggle" onclick="toggleConfig()">âš™ï¸</button>
    </div>

    <div class="config-panel" id="configPanel">
        <div class="provider-preset">
            <button class="preset-btn" onclick="applyPreset('anthropic')">Anthropic</button>
            <button class="preset-btn" onclick="applyPreset('openai')">OpenAI</button>
            <button class="preset-btn" onclick="applyPreset('zhipuai')">æ™ºè°±AI</button>
            <button class="preset-btn" onclick="applyPreset('ollama')">Ollama</button>
            <button class="preset-btn" onclick="applyPreset('deepseek')">DeepSeek</button>
            <button class="preset-btn" onclick="applyPreset('custom')">è‡ªå®šä¹‰</button>
        </div>

        <div class="config-row">
            <label>API åœ°å€ (Base URL)</label>
            <input type="text" id="baseUrl" placeholder="https://api.anthropic.com" />
        </div>

        <div class="config-row">
            <label>API å¯†é’¥ (Auth Token)</label>
            <input type="password" id="authToken" placeholder="sk-ant-api03-..." />
        </div>

        <div class="config-row">
            <label>æ¨¡å‹ (Model)</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="modelName" placeholder="claude-3-5-sonnet-20241022" style="flex: 1;" />
                <button class="preset-btn" onclick="fetchModels()" title="è·å–æ¨¡å‹åˆ—è¡¨" id="fetchModelsBtn">ğŸ“‹</button>
            </div>
            <select id="modelSelect" style="display: none; margin-top: 5px;" onchange="document.getElementById('modelName').value = this.value;">
                <option value="">-- é€‰æ‹©æ¨¡å‹ --</option>
            </select>
        </div>

        <div class="config-row">
            <label>API æ ¼å¼</label>
            <select id="apiFormat" onchange="onApiFormatChange()">
                <option value="anthropic">Anthropic (Messages API)</option>
                <option value="openai">OpenAI (Chat Completions)</option>
            </select>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="preset-btn" style="width: 100%; padding: 10px;" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            <button class="preset-btn" style="width: 100%; padding: 10px;" onclick="fetchModels()">è·å–æ¨¡å‹åˆ—è¡¨</button>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="message assistant">
            <div class="avatar">AI</div>
            <div class="message-content">
                ä½ å¥½ï¼æˆ‘æ˜¯ AI åŠ©æ‰‹ï¼Œæ”¯æŒæµå¼è¾“å‡ºã€‚è¯·å…ˆç‚¹å‡»å³ä¸Šè§’ âš™ï¸ é…ç½® APIï¼Œç„¶åå¼€å§‹å¯¹è¯ã€‚
            </div>
        </div>
    </div>

    <div class="input-container">
        <div class="input-wrapper">
            <textarea id="userInput" placeholder="è¾“å…¥é—®é¢˜... (Shift+Enter æ¢è¡Œ)" rows="2"></textarea>
            <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
        </div>
        <div class="actions">
            <button class="action-btn" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
            <button class="action-btn" onclick="exportChat()">å¯¼å‡ºè®°å½•</button>
        </div>
    </div>

    <script>
        let config = {
            baseUrl: '',
            authToken: '',
            model: 'claude-3-5-sonnet-20241022',
            apiFormat: 'anthropic'
        };

        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const statusBadge = document.getElementById('statusBadge');
        let conversationHistory = [];

        function loadConfig() {
            const saved = localStorage.getItem('ai-chat-streaming-config');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('baseUrl').value = config.baseUrl || '';
                document.getElementById('authToken').value = config.authToken || '';
                document.getElementById('modelName').value = config.model || '';
                document.getElementById('apiFormat').value = config.apiFormat || 'anthropic';
                updateStatus();
            }
        }

        // éªŒè¯é…ç½®
        async function validateConfig(baseUrl, authToken, model, apiFormat) {
            if (!baseUrl || !authToken || !model) {
                return { valid: false, message: 'è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯ï¼ˆAPI åœ°å€ã€å¯†é’¥ã€æ¨¡å‹ï¼‰' };
            }

            let url, headers, body;

            if (apiFormat === 'anthropic') {
                url = `${baseUrl.replace(/\/$/, '')}/v1/messages`;
                headers = {
                    'x-api-key': authToken,
                    'anthropic-version': '2023-06-01',
                    'content-type': 'application/json',
                    'dangerously-allow-browser': 'true'
                };
                body = {
                    model: model,
                    max_tokens: 100,
                    messages: [{ role: 'user', content: 'Hi' }]
                };
            } else {
                // OpenAI æ ¼å¼
                url = `${baseUrl.replace(/\/$/, '')}/chat/completions`;
                headers = {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                };
                body = {
                    model: model,
                    messages: [{ role: 'user', content: 'Hi' }],
                    max_tokens: 100
                };
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.error?.message || errorData.message || `HTTP ${response.status}`;

                    // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´å‹å¥½çš„æç¤º
                    if (response.status === 401 || response.status === 403) {
                        return { valid: false, message: `API å¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ (${errorMsg})` };
                    } else if (response.status === 404) {
                        return { valid: false, message: `æ¨¡å‹ "${model}" ä¸å­˜åœ¨æˆ–ç«¯ç‚¹é”™è¯¯ (${errorMsg})` };
                    } else if (response.status === 429) {
                        return { valid: false, message: `è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯• (${errorMsg})` };
                    } else if (errorMsg.includes('ä½™é¢') || errorMsg.includes('èµ„æºåŒ…')) {
                        return { valid: false, message: `è´¦æˆ·ä½™é¢ä¸è¶³æˆ–èµ„æºåŒ…å·²ç”¨å®Œ (${errorMsg})` };
                    } else {
                        return { valid: false, message: `é…ç½®éªŒè¯å¤±è´¥: ${errorMsg}` };
                    }
                }

                return { valid: true, message: 'é…ç½®éªŒè¯æˆåŠŸï¼' };
            } catch (error) {
                return { valid: false, message: `ç½‘ç»œé”™è¯¯: ${error.message}` };
            }
        }

        // ä¿å­˜é…ç½®ï¼ˆå¸¦éªŒè¯ï¼‰
        async function saveConfig() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const authToken = document.getElementById('authToken').value.trim();
            const model = document.getElementById('modelName').value.trim();
            const apiFormat = document.getElementById('apiFormat').value;

            if (!baseUrl || !authToken || !model) {
                alert('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯');
                return;
            }

            // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œæ˜¾ç¤ºéªŒè¯ä¸­çŠ¶æ€
            const saveBtn = event.target;
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'éªŒè¯ä¸­...';

            addMessage('assistant', 'æ­£åœ¨éªŒè¯é…ç½®ï¼Œè¯·ç¨å€™...');

            // éªŒè¯é…ç½®
            const result = await validateConfig(baseUrl, authToken, model, apiFormat);

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;

            if (result.valid) {
                // éªŒè¯æˆåŠŸï¼Œä¿å­˜é…ç½®
                config.baseUrl = baseUrl;
                config.authToken = authToken;
                config.model = model;
                config.apiFormat = apiFormat;

                localStorage.setItem('ai-chat-streaming-config', JSON.stringify(config));
                updateStatus();
                toggleConfig();
                addMessage('assistant', 'âœ… é…ç½®éªŒè¯æˆåŠŸå¹¶å·²ä¿å­˜ï¼ç°åœ¨å¯ä»¥å¼€å§‹å¯¹è¯äº†ã€‚');
            } else {
                // éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                addMessage('assistant', `âŒ ${result.message}\n\nè¯·æ£€æŸ¥é…ç½®åé‡è¯•ã€‚`);
            }
        }

        function updateStatus() {
            if (config.baseUrl && config.authToken) {
                statusBadge.textContent = 'å·²é…ç½®';
                statusBadge.className = 'status-badge status-configured';
            } else {
                statusBadge.textContent = 'æœªé…ç½®';
                statusBadge.className = 'status-badge status-unconfigured';
            }
        }

        function applyPreset(preset) {
            const presets = {
                anthropic: {
                    baseUrl: 'https://api.anthropic.com',
                    model: 'claude-3-5-sonnet-20241022',
                    apiFormat: 'anthropic'
                },
                openai: {
                    baseUrl: 'https://api.openai.com/v1',
                    model: 'gpt-4o-mini',
                    apiFormat: 'openai'
                },
                zhipuai: {
                    baseUrl: 'https://open.bigmodel.cn/api/anthropic',
                    model: 'glm-4-plus',
                    apiFormat: 'anthropic'
                },
                ollama: {
                    baseUrl: 'http://localhost:11434/v1',
                    model: 'llama3',
                    apiFormat: 'openai'
                },
                deepseek: {
                    baseUrl: 'https://api.deepseek.com/v1',
                    model: 'deepseek-chat',
                    apiFormat: 'openai'
                },
                custom: {
                    baseUrl: '',
                    model: '',
                    apiFormat: 'anthropic'
                }
            };

            const p = presets[preset];
            document.getElementById('baseUrl').value = p.baseUrl;
            document.getElementById('modelName').value = p.model;
            document.getElementById('apiFormat').value = p.apiFormat;
        }

        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            panel.classList.toggle('show');
        }

        // API æ ¼å¼å˜åŒ–æ—¶æ›´æ–°æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹æç¤º
        function onApiFormatChange() {
            // å¯ä»¥æ ¹æ®ä¸åŒæ ¼å¼æ˜¾ç¤ºä¸åŒçš„æç¤º
        }

        // è·å–æ¨¡å‹åˆ—è¡¨
        async function fetchModels() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const authToken = document.getElementById('authToken').value.trim();
            const apiFormat = document.getElementById('apiFormat').value;
            const fetchBtn = document.getElementById('fetchModelsBtn');
            const modelSelect = document.getElementById('modelSelect');

            if (!baseUrl || !authToken) {
                alert('è¯·å…ˆé…ç½® API åœ°å€å’Œå¯†é’¥');
                return;
            }

            fetchBtn.disabled = true;
            fetchBtn.textContent = 'â³';

            try {
                let url, headers, models = [];

                if (apiFormat === 'openai') {
                    url = baseUrl.replace(/\/$/, '') + '/models';
                    headers = {
                        'Authorization': `Bearer ${authToken}`
                    };
                } else {
                    url = baseUrl.replace(/\/$/, '') + '/models';
                    headers = {
                        'x-api-key': authToken,
                        'anthropic-version': '2023-06-01'
                    };
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.data && Array.isArray(data.data)) {
                    models = data.data.map(m => m.id);
                } else if (data.models && Array.isArray(data.models)) {
                    models = data.models.map(m => m.id || m.name);
                } else if (Array.isArray(data)) {
                    models = data.map(m => m.id || m.name);
                }

                if (models.length === 0) {
                    models = getFallbackModels(apiFormat, baseUrl);
                }

                modelSelect.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡å‹ --</option>' +
                    models.map(m => `<option value="${m}">${m}</option>`).join('');
                modelSelect.style.display = 'block';

                const firstModel = models[0];
                if (firstModel) {
                    document.getElementById('modelName').value = firstModel;
                    addMessage('assistant', `æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹ã€‚å·²é€‰æ‹©: ${firstModel}`);
                }

            } catch (error) {
                console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);

                const fallbackModels = getFallbackModels(apiFormat, baseUrl);
                modelSelect.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡å‹ --</option>' +
                    fallbackModels.map(m => `<option value="${m}">${m}</option>`).join('');
                modelSelect.style.display = 'block';

                addMessage('assistant', `API ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨ã€‚å·²åŠ è½½ ${fallbackModels.length} ä¸ªé¢„è®¾æ¨¡å‹ã€‚\n\næç¤º: ${error.message}`);
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'ğŸ“‹';
            }
        }

        // è·å–é¢„è®¾æ¨¡å‹åˆ—è¡¨ï¼ˆå½“ API ä¸æ”¯æŒ /models æ—¶ï¼‰
        function getFallbackModels(apiFormat, baseUrl) {
            const url = baseUrl.toLowerCase();

            if (url.includes('bigmodel.cn') || url.includes('zhipuai')) {
                return ['glm-4-plus', 'glm-4-flash', 'glm-4-air', 'glm-4-flashx', 'glm-4-0520', 'glm-3-turbo'];
            }

            if (url.includes('api.openai.com')) {
                return ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-3.5-turbo', 'o1-preview', 'o1-mini'];
            }

            if (url.includes('api.anthropic.com')) {
                return ['claude-3-5-sonnet-20241022', 'claude-3-5-haiku-20241022', 'claude-3-opus-20240229'];
            }

            if (url.includes('deepseek')) {
                return ['deepseek-chat', 'deepseek-coder'];
            }

            if (url.includes('localhost') || url.includes('11434')) {
                return ['llama3', 'llama3:8b', 'mistral', 'qwen2', 'codellama', 'phi3'];
            }

            if (apiFormat === 'anthropic') {
                return ['claude-3-5-sonnet-20241022', 'claude-3-5-haiku-20241022'];
            } else {
                return ['gpt-4o-mini', 'llama3'];
            }
        }

        function addMessage(role, content, isStreaming = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = role === 'user' ? 'U' : 'AI';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isStreaming) {
                contentDiv.id = 'streaming-content';
                const indicator = document.createElement('div');
                indicator.className = 'typing-indicator';
                indicator.innerHTML = '<span></span><span></span><span></span>';
                contentDiv.appendChild(indicator);
            } else {
                contentDiv.innerHTML = formatContent(content);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return contentDiv;
        }

        function formatContent(text) {
            // ç”Ÿæˆå”¯ä¸€ID
            let codeBlockIndex = 0;

            // å¤„ç†ä»£ç å—
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                const blockId = `code-block-${Date.now()}-${codeBlockIndex++}`;
                const language = lang || 'text';
                const escapedCode = escapeHtml(code);
                return `
                    <div class="code-block" id="${blockId}">
                        <div class="code-header">
                            <span class="code-lang">${language}</span>
                            <div class="code-actions">
                                <button class="code-btn" onclick="toggleCode('${blockId}')">
                                    <span>â–¼</span> æŠ˜å 
                                </button>
                                <button class="code-btn" onclick="copyCode('${blockId}', this)">
                                    <span>ğŸ“‹</span> å¤åˆ¶
                                </button>
                            </div>
                        </div>
                        <div class="code-content">
                            <pre><code>${escapedCode}</code></pre>
                        </div>
                    </div>
                `;
            });

            // å¤„ç†è¡Œå†…ä»£ç 
            text = text.replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>');

            // å¤„ç†æ¢è¡Œï¼ˆä½†ä¸åœ¨ä»£ç å—å†…ï¼‰
            text = text.replace(/\n/g, '<br>');

            return text;
        }

        // è½¬ä¹‰ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆ‡æ¢ä»£ç å—æŠ˜å 
        function toggleCode(blockId) {
            const block = document.getElementById(blockId);
            if (!block) return;

            const content = block.querySelector('.code-content');
            const btn = block.querySelector('.code-actions .code-btn:first-child');

            content.classList.toggle('collapsed');

            if (content.classList.contains('collapsed')) {
                btn.innerHTML = '<span>â–¶</span> å±•å¼€';
            } else {
                btn.innerHTML = '<span>â–¼</span> æŠ˜å ';
            }
        }

        // å¤åˆ¶ä»£ç 
        async function copyCode(blockId, btn) {
            const block = document.getElementById(blockId);
            if (!block) return;

            const code = block.querySelector('code');
            const text = code.textContent;

            try {
                await navigator.clipboard.writeText(text);

                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>âœ“</span> å·²å¤åˆ¶';
                btn.classList.add('copied');

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                btn.innerHTML = '<span>âœ“</span> å·²å¤åˆ¶';
                btn.classList.add('copied');

                setTimeout(() => {
                    btn.innerHTML = '<span>ğŸ“‹</span> å¤åˆ¶';
                    btn.classList.remove('copied');
                }, 2000);
            }
        }

        // åˆ›å»ºæ€è€ƒè¿‡ç¨‹åŒºå—
        function createThinkingBlock() {
            const block = document.createElement('div');
            block.className = 'thinking-block';

            const header = document.createElement('div');
            header.className = 'thinking-header collapsed';
            header.innerHTML = `
                <span class="toggle-icon">â–¼</span>
                <span class="label">ğŸ’­ æ€è€ƒè¿‡ç¨‹</span>
                <span class="thinking-status">æ€è€ƒä¸­...</span>
            `;
            header.onclick = () => toggleThinking(header);

            const content = document.createElement('div');
            content.className = 'thinking-content collapsed';

            block.appendChild(header);
            block.appendChild(content);

            return block;
        }

        // åˆ‡æ¢æ€è€ƒè¿‡ç¨‹æŠ˜å çŠ¶æ€
        function toggleThinking(header) {
            const content = header.nextElementSibling;
            const status = header.querySelector('.thinking-status');

            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');

            if (header.classList.contains('collapsed')) {
                status.textContent = 'å·²æŠ˜å ';
            } else {
                status.textContent = 'å±•å¼€æŸ¥çœ‹';
            }
        }

        async function sendMessage() {
            const prompt = userInput.value.trim();

            if (!prompt) return;

            if (!config.baseUrl || !config.authToken) {
                alert('è¯·å…ˆé…ç½® API åœ°å€å’Œå¯†é’¥');
                toggleConfig();
                return;
            }

            addMessage('user', prompt);
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;

            const streamingContent = addMessage('assistant', '', true);

            try {
                let url, headers, body;

                if (config.apiFormat === 'anthropic') {
                    url = `${config.baseUrl}/v1/messages`;
                    headers = {
                        'x-api-key': config.authToken,
                        'anthropic-version': '2023-06-01',
                        'content-type': 'application/json',
                        'dangerously-allow-browser': 'true'
                    };
                    body = {
                        model: config.model,
                        max_tokens: 4096,
                        stream: true,
                        messages: [...conversationHistory, { role: 'user', content: prompt }]
                    };
                    // å¯ç”¨æ‰©å±•æ€è€ƒï¼ˆå¦‚æœæ¨¡å‹æ”¯æŒï¼‰
                    if (config.model.includes('claude')) {
                        body.extended_thinking = {
                            max_tokens: 8000
                        };
                    }
                } else {
                    url = `${config.baseUrl}/chat/completions`;
                    headers = {
                        'Authorization': `Bearer ${config.authToken}`,
                        'Content-Type': 'application/json'
                    };
                    body = {
                        model: config.model,
                        messages: [...conversationHistory, { role: 'user', content: prompt }],
                        max_tokens: 4096,
                        stream: true
                    };
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error('API è¯·æ±‚å¤±è´¥');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';
                let thinkingContent = '';
                let thinkingBlock = null;
                let contentBlock = null;

                streamingContent.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                let text = '';
                                let isThinking = false;

                                if (config.apiFormat === 'anthropic') {
                                    if (parsed.type === 'content_block_start') {
                                        // æ£€æŸ¥å†…å®¹å—ç±»å‹
                                        if (parsed.content_block?.type === 'thinking') {
                                            isThinking = true;
                                            // åˆ›å»ºæ€è€ƒè¿‡ç¨‹åŒºå—
                                            if (!thinkingBlock) {
                                                thinkingBlock = createThinkingBlock();
                                                streamingContent.appendChild(thinkingBlock);
                                                // è‡ªåŠ¨å±•å¼€æ€è€ƒè¿‡ç¨‹
                                                const header = thinkingBlock.querySelector('.thinking-header');
                                                header.classList.remove('collapsed');
                                                const content = thinkingBlock.querySelector('.thinking-content');
                                                content.classList.remove('collapsed');
                                            }
                                        }
                                    } else if (parsed.type === 'content_block_delta') {
                                        // æ€è€ƒå†…å®¹çš„ delta
                                        if (parsed.delta?.thinking !== undefined) {
                                            text = parsed.delta.thinking || '';
                                            isThinking = true;
                                        } else if (parsed.delta?.text !== undefined) {
                                            text = parsed.delta.text || '';
                                        }
                                    }
                                } else {
                                    // OpenAI æ ¼å¼
                                    if (parsed.choices && parsed.choices[0]?.delta?.content) {
                                        text = parsed.choices[0].delta.content;
                                    }
                                }

                                if (text) {
                                    if (isThinking && thinkingBlock) {
                                        // æ›´æ–°æ€è€ƒå†…å®¹
                                        thinkingContent += text;
                                        const thinkingContentDiv = thinkingBlock.querySelector('.thinking-content');
                                        thinkingContentDiv.innerHTML = formatContent(thinkingContent);
                                    } else {
                                        // æ›´æ–°æ­£æ–‡å†…å®¹
                                        if (!contentBlock) {
                                            contentBlock = document.createElement('div');
                                            contentBlock.className = 'response-content';
                                            streamingContent.appendChild(contentBlock);
                                        }
                                        fullContent += text;
                                        contentBlock.innerHTML = formatContent(fullContent);
                                    }
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯
                            }
                        }
                    }
                }

                // æ€è€ƒè¿‡ç¨‹å®Œæˆåè‡ªåŠ¨æŠ˜å 
                if (thinkingBlock) {
                    setTimeout(() => {
                        const header = thinkingBlock.querySelector('.thinking-header');
                        if (header && !header.classList.contains('collapsed')) {
                            toggleThinking(header);
                        }
                    }, 500);
                }

                conversationHistory.push(
                    { role: 'user', content: prompt },
                    { role: 'assistant', content: fullContent }
                );

            } catch (error) {
                streamingContent.innerHTML = `<span style="color: #e94560;">é”™è¯¯: ${error.message}</span>`;
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯å—ï¼Ÿ')) {
                chatContainer.innerHTML = '<div class="message assistant"><div class="avatar">AI</div><div class="message-content">å¯¹è¯å·²æ¸…ç©ºï¼Œå¯ä»¥å¼€å§‹æ–°çš„å¯¹è¯äº†ã€‚</div></div>';
                conversationHistory = [];
            }
        }

        function exportChat() {
            const text = conversationHistory.map(m => `${m.role}: ${m.content}`).join('\n\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-chat-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 150) + 'px';
        });

        loadConfig();
    </script>
</body>
</html>
